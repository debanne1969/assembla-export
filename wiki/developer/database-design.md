
      
      
      
      
      
      
<p><span style="background-color: rgb(255, 153, 0);"> work in progress</span></p><p><span style="color: rgb(17, 17, 17); font-family: inherit; font-size: 18px; font-weight: bold; line-height: 22px;">New database design for version 2.0 - specifications</span></p><p>Guiding principle: </p><p></p><ul><li><span style="line-height: 20px; font-size: 100%;">a database design that makes it easy to support multiple databases.  That means no complex queries and no engine specific data types.  The application is so simple that complex queries should not be needed anyway.</span></li><li><span style="line-height: 20px; font-size: 100%;">a database design that easily explains what data we gather and why</span></li><li><span style="line-height: 20px; font-size: 100%;">a database design that is easy to use with the intended class design and makes it easy to expand on in the years to come</span></li><li><span style="line-height: 20px; font-size: 100%;">a database design which make update as easy and scriptable as possible <br></span></li></ul><div><br></div><div>Up until now (version 1.6 release, version 2.0-alpha-summer2013) the database design was effectively based on 2 tables: one for logs and one for everything else. This has served us well but also has some issues.  It's hard for new coders to figure out what data is used for what purpose.  It is relatively hard to come up with ways to incorporate new functionality in a very restricted database environment.  And because everything uses the same record structure the chances that new functionality in for example guest use vouchers introduces issues in the basic file transfer functionality are high.  With every new feature there is a significant chance of collateral damage.</div><div><br></div><div>The new database design intends to fix these issues.  It also intends to make some functionality clearer than it was before.  A good example of this is the new auditlog table.  When FileSender launched its first prototype we did not know the audit trail capability was a feature that was of crucial importance to most users.  It turns out our user base really cares what happens with their files.  It seems like a good idea to redesign the audit trail data model and ensure we store all we need to provide a solid trail to the end user.   </div><div> </div><p></p><h2>Tables</h2><div><br></div><div>Tables related to core functionality: transferring files.  The basic component is a transfer. A transfer can have one or more files being transferred.  A transfer can have one or more recipients.  All activity regarding a transfer, its files or recipients will be logged in the auditlog and statlog tables.  Note that the transfer table is proposed to have an "options" field with key-value pairs.  That way we can create new options without changing the database.</div><div><br></div><div><ul><li><b>Transfers: </b>the container for files, recipients and transfer-related meta-data.  Transfer owner (UID from IdP), sender's name, message, subject, expiry data (introduce a valid from and a valid until?  Useful for public procurement processes :), status (in upload, available for download, expired, etc. figure out what works), options.  The options field will contain key-value pairs (JSON format?) for all options like which emails to send, fileId, recipientIds, etc.</li><li><b>Files</b>: file name, file size, file integrity check code (?), transaction Id, fieId, ?</li><li><b>Recipients:</b> stores all information about recipients.  Unique recipient Id, Email address, download URL/token, whether or not the "send email when download complete" option is available for this user, date when the recipient was added, whether or not the recipient is active</li></ul><div><br></div><div>I included the auditlog as a table related to core functionality: any transaction on a file can not be considered completed until the audit log has been written (!).  This is a direct consequence of wanting to be able to offer a solid guarantee to users the audit log provides an accurate overview of everything that happened with a file.</div><ul><li><b style="font-size: 100%;">Auditlogs: </b><span style="font-size: 100%;">stores the audit trail information.  Everything that happens to/with a file, voucher or user record is stored here. Events that are related to -</span></li><ul><li>a single file (upload, download, removal)</li><li>a group of files (i.e. a transfer)</li><li>a user's activity (has the user not made transfers in a long time? Is it time to remove their data?)</li><li>a voucher (has the recipient used it? Is it expired, canceled then removed?)</li><li>When a USER is removed, then so is the "catalog" of his recipients (their data in the DB). Not practical to let recipient records expire while user is still active.</li></ul></ul><div><br></div><div>Supporting tables:</div><ul><li><b>Users:</b> this is <b>NOT</b> a user database.  This table stores user preferences and defaults to allow us to tick the option boxes the user wants ticket upon log on.  User UID (as received from IdP), which options a user usually has set.  Must include a field on whether or not the AuP tick was set and when that was done.  Has an implication on data handling agreements etc.  Ideally the AuP is ticket on first-logon and then the AuP question only comes up again when the AuP is changed.</li><li><b>Guestvouchers: </b>stores all information related to the guest usage authentication voucher functionality.  Owner UID, recipient, validity period, number of transactions the voucher is good for, optional message, subject, the actual login token, whether or not all options are accessible for the voucher user, etc.  The table's functionality could be split but that likely leads to more complexity than is worth the bother.</li></ul><ul><li><b>Statslogs:</b> stores an anonymised version of the audit trail information which can be used for generating statistics</li></ul><div><br></div></div><h4>About the life time of tuples in the database</h4><div><ul><li><span style="font-size: 100%;">Entries in the </span><span style="font-size: 100%;">transfers, files and vouchers tables exist for only as long as the actual </span><span style="font-size: 100%;">transfer or auditlog exists: once a </span><span style="font-size: 100%;">transfer and its auditlogs are expired they should disappear from the database table.  </span></li><li><span style="font-size: 100%;">Entries in the user profile should to be subject to a delete/deprovisioning policy</span></li><li><span style="font-size: 100%;">Entries in the audit log should not store the message and subject, and can in principle be removed once the file transaction expires or the voucher is no longer valid.  There should be a policy indicating when entries are purged (ties in with option to send user audit log or not, and specify an audit-trail-retention-time in the config).  A good new feature would be to allow a user to receive the audit trail for its transaction(s) when a transaction expires.  That way we can send the user a (signed?) PDF (?) and after that delete the audit trail on the server thus reducing the privacy footprint.</span></li><li><span style="font-size: 100%;">Entries in the statistics log can in principle live on forever.  A purge policy should be possible to specify (rentention time = x, 0 for forever?  What with no retention time?)</span></li></ul></div><div><br></div><div><p><span style="color: rgb(17, 17, 17); font-family: inherit; font-size: 16px; font-weight: bold; line-height: 18px;">Exact table structure</span></p><p><span style="color: rgb(17, 17, 17); font-family: inherit; font-size: 16px; font-weight: bold; line-height: 18px;"><br></span></p><h3 style="font-family: Arial, Helvetica, 'Liberation Sans', FreeSans, sans-serif;">Tables directly needed for file transfer</h3><div><table style="width: 1084px;"><tbody><tr><td colspan="3"><h4>table: Transfers</h4></td></tr><tr><td>Field name</td><td>Data type</td><td>Description</td></tr><tr><td>id<br></td><td>integer<span></span>, unsigned</td><td>Primary key. Not null and auto-incrementing</td></tr><tr><td>trackingid</td><td>string(10) </td><td>Tracking code for the transfer (sent to sender)<br><b>Maybe not that useful</b></td></tr><tr><td>user_id</td><td>string(255)</td><td>The sender's user ID, as generated by the IdP</td></tr><tr><td>subject</td><td>string(255)</td><td>Optional: specifies subject in the e-mail notification sent to receivers</td></tr><tr><td>message</td><td>text</td><td>Optional: message from sender to receivers</td></tr><tr><td>created</td><td>datetime</td><td>The date and time of the transaction</td></tr><tr><td>expires</td><td>datetime<br></td><td>The expiration date and time (to insure that download is available on the last day)</td></tr><tr><td>status</td><td>string(32)</td><td>Indicates status of the file transfer: uploading, available for download, expired, closed<br></td></tr><tr><td>options</td><td>text</td><td>JSON-encoded that contains data about what options were checked</td></tr></tbody></table></div><div><div><br></div><div><br class="Apple-interchange-newline"><table style="width: 991px;"><tbody><tr><td colspan="3"><h4>table: Files</h4></td></tr><tr><td>Field name</td><td>Data type</td><td>Description</td></tr><tr><td>id</td><td>integer, unsigned</td><td>Primary key. Not null and auto-incremented.</td></tr><tr><td>transfer_id</td><td>integer, unsigned</td><td>Foreign key. Not null. The ID handle of the transaction record the file is associated with.</td></tr><tr><td>name</td><td>string(255)</td><td>Name of the file, as originally specified by sender.</td></tr><tr><td>size</td><td>big integer, unsigned<br></td><td>File size in bytes.</td></tr><tr><td>sha1</td><td>string(40)</td><td>Hash code (for file integrity verification). Should be done per chunk. But leaving it as it is for now.</td></tr></tbody></table></div></div><div><br></div><div><br class="Apple-interchange-newline"><table style="width: 991px;"><tbody><tr><td colspan="3"><h4>table: Recipients</h4></td></tr><tr><td>Field name</td><td>Data type</td><td>Description</td></tr><tr><td>id</td><td>integer, unsigned</td><td>Primary key. Not null and auto-incrementing</td></tr><tr><td>transfer_id</td><td>integer, unsigned</td><td>Foreign key. Not null. ID handle for the transfer the recipient is in.</td></tr><tr><td>email</td><td>string(255) <br></td><td>The recipient's e-mail.<br></td></tr><tr><td>token<br></td><td>string(60)</td><td>Download or voucher token for each recipient. Only the latest token for a recipient is shown here.<br></td></tr><tr><td>options</td><td>text<br></td><td>JSON encoded value that tells whether recipient has asked to get "download complete" e-mail or other options<br></td></tr><tr><td>created</td><td>datetime<br></td><td>The date when the recipient record was created</td></tr><tr><td>last_activity</td><td>datetime<br></td><td>Date of last activity. Used to determine if recipient is inactive and data should be removed</td></tr></tbody></table></div><div><br></div><div><br></div><div><br class="Apple-interchange-newline"><table style="width: 991px;"><tbody><tr><td colspan="3"><h4>table: Auditlogs</h4></td></tr><tr><td>Field name</td><td>Data type</td><td>Description</td></tr><tr><td>id</td><td>integer, unsigned</td><td>Primary key. Not null and auto-incrementing</td></tr><tr><td>event</td><td>string(32)</td><td>The type of event that is logged:<br>UPLOAD, FAILED, DOWNLOAD, UPLOADED, LOG_CREATED<br><br>USER_ACTIVATED, USER_INACTIVE, USER_PURGED<br><br>FILE_UPDATED, FILE_EXPIRED, FILE_MOVED, FILE_DELETED<br><br>GUESTVOUCHER_CREATED, GUESTVOUCHER_SENT, GUESTVOUCHER_USED, GUESTVOUCHER_EXPIRED, GUESTVOUCHER_CANCEL, GUESTVOUCHER_CLOSED<br><br>TRANSFER_START, TRANSFER_END, TRANSFER_CLOSED, TRANSFER_DELETED<br><br>UPLOAD_START, UPLOAD_END<br><br>DOWNLOAD_START, DOWNLOAD_END, DOWNLOAD_RESUME</td></tr><tr><td> user_id</td><td>string(255)<br></td><td>Id of the user who triggered the event <br></td></tr><tr><td>target_id</td><td>integer, unsigned</td><td>The target of the event</td></tr><tr><td>target_type<span></span></td><td>string(255)<span></span><br></td><td>Type of the target of the event : Transfer, File, Guestvoucher ...<br></td></tr><tr><td>created</td><td>datetime</td><td>The date and time the event occured<br></td></tr><tr><td>ip</td><td>string(36)<br></td><td>The IP of the user (be it v4 or v6)<br></td></tr></tbody></table></div><div><br></div><h3 style="font-family: Arial, Helvetica, 'Liberation Sans', FreeSans, sans-serif;">Supporting tables</h3><div><br class="Apple-interchange-newline"><table style="width: 991px;"><tbody><tr><td colspan="3"><h4>table: Guestvouchers</h4></td></tr><tr><td>Field name</td><td>Data type</td><td>Description</td></tr><tr><td>id</td><td>integer, unsigned</td><td>Primary key. Not null and auto-incrementing</td></tr><tr><td>user_id</td><td>string(255)</td><td>The user who has issued the voucher/under whose name the transfer will be done.</td></tr><tr><td>token</td><td>string(60)</td><td>The voucher token</td></tr><tr><td>transfers</td><td>integer, unsigned</td><td>Nr of transfers the voucher is good for.</td></tr><tr><td>created</td><td>datetime<br></td><td>Date the voucher token was created and sent</td></tr><tr><td>expires</td><td>datetime<br></td><td>Specifies the expiration date and time of the voucher</td></tr><tr><td>subject</td><td>string(255)</td><td>The subject of the "invitation by voucher" e-mail message</td></tr><tr><td>message</td><td>text</td><td>The message body of an "invitation by voucher"</td></tr><tr><td>options</td><td>text</td><td>JSON encoded options which are accessible to voucher users when sending files (Initially ignored)</td></tr></tbody></table></div><div><br></div><div><br class="Apple-interchange-newline"><table style="width: 991px;"><tbody><tr><td colspan="3"><h4>table: Users</h4></td></tr><tr><td><b>Field name</b></td><td><b>Data type</b></td><td><b>Description</b></td></tr><tr><td>id</td><td>string(255)</td><td>From IdP authorization step, the user's ID</td></tr><tr><td>organization</td><td>string(80)</td><td>Organization the user is associated with. From IdP authorization step, can be null<br></td></tr><tr><td>aup_ticked</td><td>boolean</td><td>Whether the user's already accepted the AuP conditions by ticking the box</td></tr><tr><td>aup_last_ticked_date</td><td>datetime</td><td>date the AuP was last ticked by the user.  Allows us to figure out if this user needs to tick the AuP again due to an AuP update. Such an update should reset all users' "aup_ticked" property.</td></tr><tr><td>transfer_preferences</td><td>text</td><td>text string, JSON-encoded, that contains data about what options user had previously set</td></tr><tr><td>voucher_preferences</td><td>text</td><td>Not used currently, since there are no options to select.</td></tr><tr><td> created</td><td>datetime<br></td><td>Date and time of user preference record creation <br></td></tr><tr><td> last_activity</td><td>datetime<br></td><td>Date and time of last user activity <br></td></tr></tbody></table></div><div><br></div><div><br class="Apple-interchange-newline"><table style="width: 991px;"><tbody><tr><td colspan="3"><h4>table: Statslogs  - anonymized version of Auditlogs. E.g. fields such as file name replaced by, for instance, file ID (integer), which will be meaningless once the transfer expires and the related file records are removed - then fileID is indeed anonymous.</h4></td></tr><tr><td>Field name</td><td>Data type</td><td>Description</td></tr><tr><td>id<br></td><td>integer, unsigned<br></td><td>Primary key, not null, auto increment<br></td></tr><tr><td>event<br></td><td>string(32)</td><td>The type of event that is logged:<br>UPLOAD, FAILED, DOWNLOAD, UPLOADED, LOG_CREATED<br><br>USER_ACTIVATED, USER_INACTIVE, USER_PURGED<br><br>FILE_UPDATED, FILE_EXPIRED, FILE_MOVED, FILE_DELETED<br><br>GUESTVOUCHER_CREATED, GUESTVOUCHER_SENT, GUESTVOUCHER_USED, GUESTVOUCHER_EXPIRED, GUESTVOUCHER_CANCEL, GUESTVOUCHER_CLOSED<br><br>TRANSFER_START, TRANSFER_END, TRANSFER_CLOSED, TRANSFER_DELETED<br><br>UPLOAD_START, UPLOAD_END<br><br>DOWNLOAD_START, DOWNLOAD_END, DOWNLOAD_RESUME</td></tr><tr><td> target_type</td><td>string(32)<br></td><td> Type of the target of the event : Transfer, File, Guestvoucher ...</td></tr><tr><td> size</td><td>big integer, unsigned<br></td><td>Size of event target <br></td></tr><tr><td> created</td><td>datetime</td><td>Date and time the event occured <br></td></tr></tbody></table></div></div><div><br></div><div><h2>For reference: the database design inherited from Filesender v2.0 alpha (and most of it from v1.x)</h2></div><div><br></div><div><span style="color: rgb(17, 17, 17); font-family: inherit; font-size: 16px; font-weight: bold; line-height: 18px;">file table:</span></div><div><table style="width: 502px;" align="left" border="1"><tbody><tr><td style="width: 100px;"><b>FIELD NAME</b></td><td style="width: 175px;"><b>DATA TYPE</b></td><td><b>DESCRIPTION</b></td></tr><tr><td>fileto</td><td>text</td><td>Receiver's email address.</td></tr><tr><td>filesubject</td><td>character varying(250)</td><td>Title, used as part of subject in emails.</td></tr><tr><td>filevoucheruid</td><td>character varying(60)</td><td>Unique file id based on the combination of "file" and "to". This is used for download links.</td></tr><tr><td>filemessage</td><td>text</td><td>Message from the sender to the receiver, used as part of body in emails.</td></tr><tr><td>filefrom</td><td>character varying(250)</td><td>Sender's email address.</td></tr><tr><td>filesize</td><td>bigint</td><td>The size of the file, in bytes.</td></tr><tr><td>fileoriginalname</td><td>character varying(500)</td><td>The name of the file.</td></tr><tr><td>filestatus</td><td>character varying(60)</td><td>The status of the file, can be any one of: "", "Voucher", "Voucher Cancelled", "Closed", "Deleted".</td></tr><tr><td>fileip4address</td><td>character varying(24)</td><td>Sender's IPv4 address.</td></tr><tr><td>fileip6address</td><td>character varying(45)</td><td>Sender's IPv6 address. </td></tr><tr><td>filesendersname</td><td>character varying(250)</td><td>Never used?</td></tr><tr><td>filereceiversname</td><td>character varying(250)</td><td>Never used?</td></tr><tr><td>filevouchertype</td><td>character varying(60)</td><td>Never used?</td></tr><tr><td>fileuid</td><td>character varying(60)</td><td>Unique file id.</td></tr><tr><td><b>fileid</b></td><td><b>integer</b></td><td><b>Primary key. Auto incrementing number.</b></td></tr><tr><td>fileexpirydate</td><td>timestamp without time zone</td><td>The date and time at which the file will expire.</td></tr><tr><td>fileactivitydate</td><td>timestamp without time zone</td><td>The date and time at which the file entry was last updated.</td></tr><tr><td>fileauthuseruid</td><td>character varying(500)</td><td>Uniquely identifies users based on their authentication.</td></tr><tr><td>filecreateddate</td><td>timestamp without time zone</td><td>The date and time at which the file was uploaded.</td></tr><tr><td>fileauthurl</td><td>character varying(500)</td><td>Never used?</td></tr><tr><td>fileauthuseremail</td><td>character varying(255)</td><td>User's email address, based on their authentication data.</td></tr><tr><td>filegroupid</td><td>character varying (60)</td><td>a multi-file transaction consists of individual files (and file records) with the same groupid</td></tr><tr><td>filetrackingcode<span> <span>    </span> </span></td><td>character varying (5)</td><td>used as a user-friendly way to identify a multi-file transaction</td></tr><tr><td>filedownloadconfirmations</td><td>character varying (5)</td><td>unsure</td></tr><tr><td>fileenabledownloadreceipts</td><td>character varying (5)</td><td>probably used to let a sender indicate a receiver is allowed to indicate they want to receive an email receipt once the download is complete</td></tr><tr><td>filedailysummary</td><td>character varying (5)</td><td>used to indicated whether or not the sender of a file wants to have a daily summery of his filesender activity (uploads, downloads)</td></tr><tr><td>filenumdownloads</td><td>integer default 0</td><td><br></td></tr><tr><td>downloaded_by_sender</td><td><br></td><td>? to indicate the sender downloaded a (group of) files directly from MyFiles</td></tr></tbody></table></div><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><h3><br></h3><p><br></p><h3>log</h3><table style="width: 502px; height: 316px;" align="left" border="1"><tbody><tr><td style="width: 100px;"><b>COLUMN NAME</b></td><td><b>DATA TYPE</b></td><td><b>DESCRIPTION</b></td></tr><tr><td><b>logid</b></td><td style="width: 175px;"><b>integer</b></td><td><b>Primary key. Auto incrementing number.</b></td></tr><tr><td>logfileuid</td><td>character varying(60)</td><td>Unique file id.</td></tr><tr><td>logtype</td><td>character varying(60)</td><td>The type of logged event. Can be any one of the following: Voucher Cancelled, Uploaded, File Removed (Expired), Error, File Moved, Updated, Upload Attempt, Download, Voucher Sent, File Cancelled, Voucher Closed.</td></tr><tr><td>logfrom</td><td>character varying(250)</td><td>Sender's email address.</td></tr><tr><td>logto</td><td>text</td><td>Receiver's email address.</td></tr><tr><td>logdate</td><td>timestamp without time zone</td><td>The date and time at which this event was logged.</td></tr><tr><td>logtime</td><td>time with time zone</td><td>Deprecated field, no longer used.</td></tr><tr><td>logfilesize</td><td>bigint</td><td>The size of the file connected to this log entry, in bytes.</td></tr><tr><td>logfilename</td><td>character varying(250)</td><td>The name of the file connected to this log entry.</td></tr><tr><td>logsessionid</td><td>character varying(60)</td><td>Never used?</td></tr><tr><td>logmessage</td><td>text</td><td>A message describing the reason for the log entry.</td></tr><tr><td>logvoucheruid</td><td>character varying(60)</td><td>Unique file id based on the combination of "file" and "to". This is used for download links.</td></tr><tr><td>logauthuseruid</td><td>character varying(500)</td><td>Uniquely identifies users based on their authentication.</td></tr><tr><td>logfilegroupid</td><td>character varying (60)</td><td><br></td></tr><tr><td>logfiletrackingcode</td><td>character varying (5)</td><td><br></td></tr><tr><td>logdailysummary</td><td>character varying (5)</td><td><br></td></tr></tbody></table><p> </p><p><br></p>

    
    
    
    
    
    
