
<p><span style="background-color: rgb(255, 153, 0);">work in progress</span></p><p><br></p><h2>Current classes</h2><p>Not all files in classes/ dir, but just the relevant classes.</p><p><br></p><h3>AuthSaml</h3><p>Methods that check if user is authenticated with SAML, is an admin (as defined in SAML config), returns authenticated user data.</p><p><b><span>This stuff should be moved to the new user class</span>.</b><br></p><p><br></p><h3>AuthVoucher</h3><p>Just a couple of methods that check if a voucher stored by id is actually a valid voucher, returns an array of voucher properties.</p><p><b><span>These methods should be moved to a voucher class.</span></b><br></p><p><span><br></span></p><h3>DB_Input_Checks</h3><p>Methods that validate data used in queries (that a string representing an e-mail is in valid e-mail format, etc).</p><p><b><span>Should be contained in an IOvalidation class ?</span></b><br></p><p><br></p><p><b>DB</b></p><p>Prepares and executes queries, loads db-relevant config data, initiates DB connection.</p><p><span>Two exception handlers (both extend <b>Exception</b>, but do not add anything) - <b>DbException</b> and <b>DbConnectExc</b>... - but handles <b>PDOexceptions</b></span><br></p><p><br></p><h3>Functions</h3><p><span>    -- </span><b>getTrackingCode</b> (some transaction class should have this instead?)</p><p><span>    -- <b>getVouchers</b> simply returns an array of vouchers that are valid. Should there be a vouchers class that holds all objects of type Voucher?</span><br></p><p><span><span>    -- checks if user is SAML authenticated. This belongs in a user class?</span><br></span></p><p><span><span><span>    -- some mail processing methods</span><br></span></span></p><p><span>    -- gets some files properties from DB table files. A class that holds an array File objects can do that</span><br></p><p><span><span>    -- gets vouchers that were created by a user. Having a Vouchers object in a User class and implementing this method in class User can be more intuitive.</span><br></span></p><p><span><span><span>    -- gets files by voucher id. Can also be moved to a transaction class, voucher class, file class?</span><br></span></span></p><p><span><span><span><span>    -- gets transaction details by querying the DB</span></span></span></span></p><p><span><span><span><span> ... (a lot more functions that can be sorted by what objects they perform stuff on and hence be moved into classes that init those objects)</span><br></span></span></span></p><p><br></p><p><b>In general, there's a lot of functions that do queries on a "need-to-know" basis and kinda omitting the whole object-oriented model. Instead the base classes can fetch data they need on initialization (interact with the DB) and the UI scripts can call methods of these objects to get what they have access t.</b> </p><p>That way the UI scripts won't see the "raw" user data in the DB, but instead in a more secure way (as described in the Pine Security audit).</p><p><br></p><h3>Mail</h3><p>Prepares and sends e-mails.</p><p><span>    -- Functions.php contain some mail related functions (like adding recipients to mail). If a Mail object is initialized when "send files" form is loaded and not on the "send" click event (does it actually work that way?), these could be moved to Mail.php</span></p><p><br></p><h3>TeraSender, Zipper</h3><p>Support classes that are not part of core functionality and should not be tinkered with unless one knows how they work.</p><p><br></p><p><br></p><h2>The classes design for version 2.0</h2><p><br></p><h3>Goal with the design</h3><ul><li><span><span></span></span>Upper-layer classes (available to the interface scripts): Functions (generic functions that do not interact with DB), IOvalidation, Mail, Zipper, Terasender, Config ...</li></ul><ul><li><span>M<span>id-level (base classes that interact with data): File, Files (to hold an array of File objects), User, Transaction, Transactions, Voucher, Vouchers, ...</span></span><br></li></ul><ul><li><span><span>Low-level/DB interaction: DB class that uses PDO (which is the current DB.php)</span></span><br></li></ul><p><br></p><p>An important thing is that we start droping hand-made singleton implementations (<b>getInstance</b> methods) in favor of mostly static classes, this reduces memory footprint and makes related code about 15% faster (benchmarked).<br></p><h3>Classes in new design<br></h3><p><br></p><p>Most class names have been choosen to represent best what is their purpose and if possible to avoid conflict with existing name so that code refactoring can be done while keeping old code bits and still be working.</p><p><br></p><h4>Core exceptions</h4><p><i>File : classes/Exceptions.class.php</i></p><p> </p><p>Defines core exceptions :</p><ul><li><b>LoggingException</b> which takes a message code to display error to the user and additionnal details to log, linking the 2 with an error code that can be displayed to the user, used in an error report form ...</li><li><b>DetailedException</b> (extends <b>LoggingException</b>) which logs the stack trace and given additionnal details (any other mixed args after the message code)</li></ul><p> </p><p>All exceptions, anywhere in the code should extend one of those, preferably <b>DetailedException</b>.</p><p> <br></p><h4>Config</h4><p><i>File : classes/Config.class.php</i> </p><p><br></p><p>Takes care of config file loading, configuration parameter read.</p><p><br></p><p>Only exposed methods is <b>get</b>, to get the value of a given parameter (or a set of parameters that have the same prefix by using wildcard *).</p><p><br></p><p>At first it should still have the <b>getInstance</b> method and implement <b>arrayaccess</b> to suport old config access style and should log when old access is done in debug mode with calling script and line so that we can track down remnants of old code.</p><p><br></p><p>Configuration defaults can be set in <b>includes/ConfigDefaults.php</b> as a <b>$default</b> array indexed by parameter name.</p><p><br></p><p>Parameters post-processors can be set in <b>includes/ConfigProcessors.php</b> as a <b>$processor</b> array indexed by parameter name and pointing processor name (processors are methods from <b>Config</b> class named like <b>processorProcessornamewithfirstletteruppercased</b>).<br></p><p><br></p><p>Usage :</p><pre style="max-width: 1245px;">$foo = Config::get('foo');</pre><pre style="max-width: 1245px;">$db_parameters = Config::get('db_*'); // Array of parameters whose keys begin with 'db_', returned keys are stripped from the prefix<br></pre><p>Along with the <b>Config</b> class those exceptions (all extending <b>DetailedException</b>) are defined :</p><ul><li><b>ConfigFileMissingException</b><br></li><li><b>ConfigBadParameterException</b></li><li><b>ConfigCannotSetException</b> temporarly used until old access style code is put down<br></li><li><b>ConfigUnknownProcessorException</b> used to report that given post-processor does not exist<br></li></ul><h4>DBI</h4><p><i>File : classes/DBI.class.php</i></p><p><br></p><p>Database interface handler.</p><p><br></p><p>Why renaming this one : the idea behind classes name is that they indicates what they represent and allows to manipulate, since this class represent an interface to the database and not the database itself this is more like a <b>DatabaseInterface</b> class than a <b>Database</b> or <b>DB</b> class, but this is a long name, so <b>DBI</b>.</p><p><br></p><p>It exposes the same methods as a <b>PDO</b> instance (through use of magic <b>__callStatic</b>), so one can use it as :</p><pre style="max-width: 1245px;">$statement = DBI::prepare('SELECT * FROM foo where bar = :bar');</pre><pre style="max-width: 1245px;">$statement->execute(array(':bar' => $bar));<br></pre><p><br></p><p>Along with the <b>DBI</b> class those exceptions (all extending <b>DetailedException</b> or a child of it) are defined :</p><ul><li><b>DBIConnexionException</b><br></li><li><b>DBIConnexionMissingParameterException</b></li><li><b>DBIUsageException</b></li></ul><p><br></p><h4>DBObject</h4><p><i>File : classes/DBObject.class.php</i></p><p><br></p><p>Base database stored object class, every stored object class must extend that one.</p><p><br></p><p>It provides easing methods to cache objects (to avoid loading them several times, thus sparing memory and cpu), converters from and to database compliant data, methods to insert or update database records ...</p><p> </p><p>It also provides a way to define database fields to be used in install/update scripts. <br></p><p><br></p><p>Exposed methods (inherited by children) are :</p><ul><li><b>fromId</b> to get object in cache from its id and load it if not in cache</li><li><b>fromData</b> to get object in cache from its id and fill it from already loaded data it if not in cache</li><li><b>fillFromDBData</b> to fill object properties from database returned data, handling typecasting on the fly</li><li><b>toDBData</b> to get a database compliant data set from the object, handling typecasting on the fly</li><li><b>getDBTable</b> to get the object's table name, handling prefix if needed <b>(object classes must use this instead of hardcoded table name)</b><br></li><li><b>updateRecord</b> to update an existing record (selected from its id) from database compliant data<br></li><li><b>insertRecord</b> to insert a new record from database compliant data</li></ul><p> </p><p>Along with the <b>DBObject</b> class those exceptions (all extending <b>DetailedException</b> or a child of it) are defined :</p><ul><li><b>PropertyAccessException</b> used in child classes' magic getters/setters to tells that accessed property does not exist</li></ul><br><p></p><h4>Transaction</h4><p><i>File : classes/Transaction.class.php</i></p><p><i> </i> </p><p>Represent the act of sending one or more file to one or more recipient, extends <b>DBObject</b>.</p><p> </p><p>It defines its stored fields in the $dataMap static property.</p><p> </p><p>It exposes setters and getters to access main transaction properties. <br></p><p> </p><p>It exposes various methods to interract with a single transaction :</p><ul><li><b>addRecipient</b></li><li><b>removeRecipient</b></li><li><b>addFile</b></li><li><b>removeFile</b></li><li>...</li></ul><p> </p><p>It also provides methods to get transactions sets :</p><ul><li><b>fromId</b> (inherited) to get a transaction from its primary key (cache)<br></li><li><b>fromData</b> (inherited) to fill a transaction object from an already loaded table row (cache)</li><li><b>fromVoucher</b> to get a transaction from an upload voucher (cache)</li><li><b>create</b> to create a new transaction at upload start</li><li><b>getExpired</b> to list expired transactions for removal</li></ul><br><p>Along with the <b>Transaction</b> class those exceptions (all extending <b>DetailedException</b> or a child of it) are defined :</p><ul><li><b>TransactionNotFoundException</b></li></ul><p><br></p><h4>Recipient</h4><p><i>File : classes/Recipient.class.php</i></p><p><br></p><p>Represent a recipient (from transaction or maybe invitation), provides methods to create one from transaction/invitation and email and to delete it.<br></p><p><br></p><h4>File</h4><p><i>File : classes/File.class.php</i></p><p><br></p><p>Represent an uploaded file, provides transaction accessor (magic getter), creator from transaction, filename and size, methods to add and read chunk from offset ...<br></p><p><br></p><h4>Invitation</h4><p><i>File : classes/Invitation.class.php</i></p><p><br></p><p>Represent an invitation, provides send method which uses Mail class to send invitations, may use <b>Recipients</b> class (?).<br></p><p><br></p><h4>User</h4><p><i>File : classes/User.class.php</i></p><p><br></p><p>Provides access to user preferences (lang, upload and invitation options).</p><p>May hold current user, offering a way for <b>Auth*</b> classes to set it along with several properties (IdP, name ...).<br></p><p><br></p><h4>AuditLog</h4><p><i>File : classes/AuditLog.class.php</i></p><p><br></p><p>Represent a audit log entry, provides ways to select them from user id and maybe type for display (admin, transaction files downloads ...).<br></p><p><br></p><p><br></p><h4>StatsLog</h4><p><i>File : classes/StatsLog.class.php</i></p><p><br></p><p>Represent a stats log entry, provides ways to select them.<br></p><p><br></p><p><br></p><h4>IOValidation</h4><p><i>File : classes/IOValidation.class.php</i></p><p><br></p><p>Holds various data validators (which throws dedicated exceptions) as static methods.</p><p><br></p><p>Avaliable validators are :</p><p> </p><p>Along with the <b>IOValidation</b> class those exceptions (all extending <b>DetailedException</b> or a child of it) are defined :</p><p></p><p></p><p><b> </b></p><h4>Utilities <br></h4><p><i>File : classes/Utilities.class.php</i></p><p><br></p><p>Holds various utilities as static methods :</p><ul><li><b>generateUID</b> to generate upload voucher, download voucher, invitation voucher</li><li><b>formatDate</b> to format php timestamps as per configuration</li><li><b>sizeToBytes</b> to turn ini file size notation into number of bytes</li></ul> <p> Along with the <b>Utilities</b> class those exceptions (all extending <b>DetailedException</b> or a child of it) are defined :</p><ul><li><b>BadSizeFormatException</b><br></li></ul><p> </p><p><b>Language</b></p><p>Some class that loads the right language file and translates language tokens (refactoring LanguageSelection should do it)<br><br>
</p>

